# OmenDB Makefile
# Convenient commands for building, testing, and development

.PHONY: help build test test-core test-storage test-index test-compression test-embedded examples clean dev install check lint format benchmark benchmark-quick benchmark-standard benchmark-enterprise benchmark-clean benchmark-deps

# Default target
help:
	@echo "OmenDB Development Commands"
	@echo "=========================="
	@echo ""
	@echo "Building:"
	@echo "  build          Build the main OmenDB binary"
	@echo "  build-debug    Build with debug symbols and memory checking"
	@echo ""
	@echo "Testing:"
	@echo "  test           Run all tests"
	@echo "  test-core      Run core module tests"
	@echo "  test-storage   Run storage module tests"
	@echo "  test-index     Run indexing module tests"
	@echo "  test-compression Run compression module tests"
	@echo "  test-embedded  Run embedded database tests"
	@echo ""
	@echo "Benchmarking:"
	@echo "  benchmark-quick       Quick benchmark (1K-10K vectors)"
	@echo "  benchmark-standard    Standard benchmark (1K-100K vectors)"
	@echo "  benchmark-enterprise  Enterprise benchmark (10K-500K vectors)"
	@echo "  benchmark-clean       Clean benchmark results"
	@echo "  benchmark-deps        Install benchmark dependencies"
	@echo ""
	@echo "Examples:"
	@echo "  examples       List available examples"
	@echo "  run-vector     Run vector operations demo"
	@echo "  run-search     Run search demo"
	@echo "  run-embedded   Run embedded database demo"
	@echo ""
	@echo "Development:"
	@echo "  dev            Enter development environment (pixi shell)"
	@echo "  install        Install dependencies"
	@echo "  check          Run type checking and validation"
	@echo "  clean          Clean build artifacts"
	@echo ""
	@echo "Environment:"
	@echo "  status         Show project status and environment info"

# Build commands
build:
	@echo "ðŸ”¨ Building OmenDB native module..."
	pixi run mojo build -I omendb omendb/native.mojo -o python/omendb/native.so --emit shared-lib
	@echo "âœ… Build complete!"

build-old:
	@echo "ðŸ”¨ Building OmenDB..."
	pixi run mojo build -I omendb src/main.mojo

build-debug:
	@echo "ðŸ”¨ Building OmenDB with debug symbols..."
	pixi run mojo build -D DEBUG=1 --debug-memory -I omendb src/main.mojo

# Test commands
test:
	@echo "ðŸ§ª Running all tests..."
	./scripts/run-test.sh

test-core:
	@echo "ðŸ§ª Running core module tests..."
	./scripts/run-test.sh core

test-storage:
	@echo "ðŸ§ª Running storage module tests..."
	./scripts/run-test.sh storage

test-index:
	@echo "ðŸ§ª Running indexing module tests..."
	./scripts/run-test.sh index

test-compression:
	@echo "ðŸ§ª Running compression module tests..."
	./scripts/run-test.sh compression

test-embedded:
	@echo "ðŸ§ª Running embedded database tests..."
	./scripts/run-test.sh embedded

# DiskANN specific tests
test-diskann:
	@echo "ðŸ§ª Testing DiskANN implementation..."
	PYTHONPATH=python pixi run python test_diskann_simple.py

test-hnsw:
	@echo "ðŸ§ª Testing HNSW implementation..."
	PYTHONPATH=python pixi run python test_hnsw_simple.py

test-algorithms:
	@echo "ðŸ§ª Testing all algorithms..."
	@make test-hnsw
	@make test-diskann

debug-diskann:
	@echo "ðŸ› Debugging DiskANN issues..."
	@echo "1. Checking native module build..."
	@make build
	@echo "2. Testing DiskANN initialization..."
	PYTHONPATH=python pixi run python -c 'import omendb; db = omendb.DB(algorithm="diskann", buffer_size=10); print("DiskANN init successful, vectors:", db.count())'
	@echo "3. Testing basic add/search..."
	PYTHONPATH=python pixi run python -c 'import omendb; db = omendb.DB(algorithm="diskann"); db.add("test", [1.0, 2.0, 3.0]); results = db.search([1.0, 2.0, 3.0], limit=1); print("Search results:", len(results), results)'

quick-test: build
	@echo "âš¡ Running quick functional tests..."
	@make test-algorithms

# Example commands
examples:
	@echo "ðŸ“š Available examples:"
	./scripts/run-example.sh

run-vector:
	@echo "ðŸš€ Running vector operations demo..."
	./scripts/run-example.sh vector_operations_demo

run-search:
	@echo "ðŸ” Running search demo..."
	./scripts/run-example.sh search_demo

run-embedded:
	@echo "ðŸ’¾ Running embedded database demo..."
	./scripts/run-example.sh embedded_demo

# Development commands
dev:
	@echo "ðŸ› ï¸  Entering development environment..."
	@echo "Run 'exit' to leave the environment"
	pixi shell

install:
	@echo "ðŸ“¦ Installing dependencies..."
	pixi install

check:
	@echo "âœ… Running type checking..."
	@echo "Note: Mojo uses built-in type checking during compilation"
	pixi run mojo --version
	@echo "Environment ready for development"

clean:
	@echo "ðŸ§¹ Cleaning build artifacts..."
	@rm -f main
	@rm -rf __pycache__
	@rm -rf .mojo_cache
	@find . -name "*.pyc" -delete
	@echo "Clean complete"

# Status and info
status:
	@echo "ðŸ“Š OmenDB Project Status"
	@echo "======================="
	@echo ""
	@echo "Environment:"
	@which pixi || echo "  âŒ pixi not found"
	@pixi --version 2>/dev/null || echo "  âŒ pixi not working"
	@pixi run mojo --version 2>/dev/null || echo "  âŒ mojo not available"
	@echo ""
	@echo "Project Structure:"
	@test -d omendb && echo "  âœ… omendb/ source directory" || echo "  âŒ omendb/ missing"
	@test -d tests && echo "  âœ… tests/ directory" || echo "  âŒ tests/ missing"
	@test -d examples && echo "  âœ… examples/ directory" || echo "  âŒ examples/ missing"
	@test -d docs && echo "  âœ… docs/ directory" || echo "  âŒ docs/ missing"
	@test -f pixi.toml && echo "  âœ… pixi.toml configuration" || echo "  âŒ pixi.toml missing"
	@echo ""
	@echo "Quick Start:"
	@echo "  make dev        # Enter development environment"
	@echo "  make test       # Run all tests"
	@echo "  make examples   # See available examples"

# Advanced targets for CI/CD
ci-test: install test
	@echo "âœ… CI test pipeline completed"

ci-build: install build
	@echo "âœ… CI build pipeline completed"

# Quick development workflow
quick: test examples
	@echo "ðŸš€ Quick development check completed"

# Comprehensive Benchmarking System
# =================================

# Quick benchmark for development and CI
benchmark-quick:
	@echo "ðŸš€ Running Quick Benchmark Suite"
	@echo "================================="
	@echo "Testing 1K-10K vectors with basic competitors"
	@echo ""
	pixi run python benchmarks/comprehensive_benchmark.py --quick
	@echo ""
	@echo "âœ… Quick benchmark complete!"
	@echo "ðŸ“Š Results saved to benchmarks/results/"

# Standard benchmark suite
benchmark-standard:
	@echo "ðŸš€ Running Standard Benchmark Suite"
	@echo "===================================="
	@echo "Testing 1K-100K vectors with full competitor analysis"
	@echo ""
	pixi run python benchmarks/comprehensive_benchmark.py --standard
	@echo ""
	@echo "âœ… Standard benchmark complete!"
	@echo "ðŸ“Š Results saved to benchmarks/results/"

# Enterprise-scale benchmark
benchmark-enterprise:
	@echo "ðŸš€ Running Enterprise Benchmark Suite"
	@echo "======================================"
	@echo "âš ï¸  Warning: This may take 30+ minutes and require 8GB+ RAM"
	@echo "Testing 10K-500K vectors with full stress testing"
	@echo ""
	@read -p "Continue? (y/N): " confirm && [ "$$confirm" = "y" ] || [ "$$confirm" = "Y" ]
	pixi run python benchmarks/comprehensive_benchmark.py --enterprise
	@echo ""
	@echo "âœ… Enterprise benchmark complete!"
	@echo "ðŸ“Š Results saved to benchmarks/results/"

# Default benchmark (standard)
benchmark: benchmark-standard

# Clean benchmark results
benchmark-clean:
	@echo "ðŸ§¹ Cleaning benchmark results..."
	@mkdir -p benchmarks/results
	@rm -f benchmarks/results/*
	@echo "âœ… Benchmark results cleaned."

# Install benchmark dependencies
benchmark-deps:
	@echo "ðŸ“¦ Installing benchmark dependencies..."
	@echo "Installing core dependencies..."
	pixi add numpy psutil
	@echo "Installing competitor libraries..."
	@echo "  - ChromaDB (embedded vector database)"
	pixi add --pypi chromadb
	@echo "  - Faiss (Facebook AI Similarity Search)"
	pixi add --pypi faiss-cpu
	@echo "  - Qdrant (high-performance vector database)"
	pixi add --pypi qdrant-client
	@echo ""
	@echo "âœ… Dependencies installed."
	@echo ""
	@echo "ðŸš€ Testing benchmark system..."
	@echo "Running quick validation test..."
	pixi run python benchmarks/comprehensive_benchmark.py --quick --no-stress --no-embeddings
	@echo ""
	@echo "âœ… Benchmark system ready!"
	@echo "Run 'make benchmark-quick' to start benchmarking"

# Specific competitor benchmarks
benchmark-omendb:
	@echo "ðŸŽ¯ OmenDB-only benchmark"
	pixi run python benchmarks/comprehensive_benchmark.py --standard --competitors omendb

benchmark-chromadb:
	@echo "ðŸŽ¯ ChromaDB comparison benchmark"
	pixi run python benchmarks/comprehensive_benchmark.py --standard --competitors omendb chromadb

benchmark-faiss:
	@echo "ðŸŽ¯ Faiss comparison benchmark"
	pixi run python benchmarks/comprehensive_benchmark.py --standard --competitors omendb faiss

benchmark-qdrant:
	@echo "ðŸŽ¯ Qdrant comparison benchmark"
	pixi run python benchmarks/comprehensive_benchmark.py --standard --competitors omendb qdrant

# System requirements check
benchmark-check:
	@echo "ðŸ” Benchmark System Requirements Check"
	@echo "======================================"
	@echo "Platform: $$(uname -s) $$(uname -m)"
	@echo "Python: $$(python --version 2>/dev/null || echo 'Not found')"
	@echo "Available Memory: $$(free -h 2>/dev/null | grep '^Mem:' | awk '{print $$7}' || echo 'Unknown')"
	@echo "Disk Space: $$(df -h . | tail -1 | awk '{print $$4}' || echo 'Unknown')"
	@echo ""
	@echo "ðŸ“Š Benchmark Dependencies:"
	@pixi run python -c "import numpy; print('  âœ… NumPy:', numpy.__version__)" 2>/dev/null || echo "  âŒ NumPy not available"
	@pixi run python -c "import psutil; print('  âœ… psutil:', psutil.__version__)" 2>/dev/null || echo "  âŒ psutil not available"
	@pixi run python -c "import chromadb; print('  âœ… ChromaDB:', chromadb.__version__)" 2>/dev/null || echo "  âš ï¸  ChromaDB not available"
	@pixi run python -c "import faiss; print('  âœ… Faiss: available')" 2>/dev/null || echo "  âš ï¸  Faiss not available"
	@pixi run python -c "import qdrant_client; print('  âœ… Qdrant: available')" 2>/dev/null || echo "  âš ï¸  Qdrant not available"
	@echo ""
	@echo "ðŸ’¡ Recommendations:"
	@echo "  Quick benchmark:      2GB RAM, 1GB disk space"
	@echo "  Standard benchmark:   4GB RAM, 2GB disk space"
	@echo "  Enterprise benchmark: 8GB RAM, 5GB disk space"
	@echo ""
	@echo "ðŸš€ To install missing dependencies: make benchmark-deps"

# Results analysis
benchmark-results:
	@echo "ðŸ“Š Benchmark Results Analysis"
	@echo "============================="
	@echo "Results directory: benchmarks/results/"
	@echo ""
	@echo "ðŸ“ Available result files:"
	@ls -la benchmarks/results/ 2>/dev/null || echo "  No results found. Run 'make benchmark-quick' first."
	@echo ""
	@echo "ðŸ“‹ Latest summary:"
	@find benchmarks/results/ -name "benchmark_summary_*.txt" -type f -exec ls -t {} + 2>/dev/null | head -1 | xargs cat || echo "  No summary files found"
	@echo ""
	@echo "ðŸ’¡ To view detailed results, check benchmarks/results/benchmark_results_*.json"